<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Task Persistence Fixes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .warning {
            color: #ffc107;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <h1>Task Persistence Fixes Verification</h1>
    
    <div class="test-section">
        <h3>Quick Tests</h3>
        <button class="test-button" onclick="testStorageManager()">Test Storage Manager</button>
        <button class="test-button" onclick="testMethodCompatibility()">Test Method Compatibility</button>
        <button class="test-button" onclick="testTaskNormalization()">Test Task Normalization</button>
    </div>
    
    <div class="test-section">
        <h3>End-to-End Tests</h3>
        <button class="test-button" onclick="testSaveLoadCycle()">Test Save/Load Cycle</button>
        <button class="test-button" onclick="testMultipleOperations()">Test Multiple Operations</button>
        <button class="test-button" onclick="testErrorHandling()">Test Error Handling</button>
    </div>
    
    <div class="test-section">
        <h3>Integration Tests</h3>
        <button class="test-button" onclick="testAppIntegration()">Test App Integration</button>
        <button class="test-button" onclick="testTodoAppInstance()">Test TodoApp Instance</button>
        <button class="test-button" onclick="testEventSystem()">Test Event System</button>
    </div>
    
    <div class="test-section">
        <h3>Debugging Tools</h3>
        <button class="test-button" onclick="clearAllStorage()">Clear All Storage</button>
        <button class="test-button" onclick="showLocalStorage()">Show localStorage</button>
        <button class="test-button" onclick="exportLogs()">Export Logs</button>
    </div>
    
    <div class="test-section">
        <h3>Test Results</h3>
        <div id="testLog" class="log-output">Test logs will appear here...</div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        let testLog = document.getElementById('testLog');
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : type === 'success' ? '[SUCCESS]' : type === 'warning' ? '[WARNING]' : '[INFO]';
            const logEntry = `${timestamp} ${prefix} ${message}\n`;
            testLog.textContent += logEntry;
            testLog.scrollTop = testLog.scrollHeight;
            console.log(`${prefix} ${message}`);
            
            // Store for export
            testResults.push({
                timestamp,
                type,
                message
            });
        }
        
        function clearLog() {
            testLog.textContent = '';
            testResults = [];
        }
        
        function exportLogs() {
            const dataStr = JSON.stringify(testResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `persistence-test-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            log('Logs exported successfully', 'success');
        }
        
        function testStorageManager() {
            clearLog();
            log('=== Testing Storage Manager ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                log('Storage Manager found:', 'success');
                log('Version:', storageManager.version);
                log('Key:', storageManager.key);
                log('Is Initialized:', storageManager.isInitialized);
                log('Is Ready:', storageManager.isReady());
                
                // Test methods
                const methods = ['getTasks', 'setTasks', 'saveTasks', 'getGamification', 'setGamification', 'getSettings', 'setSettings'];
                let allMethodsExist = true;
                
                methods.forEach(method => {
                    const exists = typeof storageManager[method] === 'function';
                    log(`Has ${method}: ${exists}`, exists ? 'success' : 'error');
                    if (!exists) allMethodsExist = false;
                });
                
                return allMethodsExist;
                
            } catch (error) {
                log('Error testing Storage Manager: ' + error.message, 'error');
                return false;
            }
        }
        
        function testMethodCompatibility() {
            clearLog();
            log('=== Testing Method Compatibility ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                // Test that both methods exist
                const hasSetTasks = typeof storageManager.setTasks === 'function';
                const hasSaveTasks = typeof storageManager.saveTasks === 'function';
                
                log('setTasks method exists:', hasSetTasks, hasSetTasks ? 'success' : 'error');
                log('saveTasks method exists:', hasSaveTasks, hasSaveTasks ? 'success' : 'error');
                
                if (!hasSetTasks || !hasSaveTasks) {
                    return false;
                }
                
                // Test that they work the same way
                const testTasks = [
                    {id: 'compat-test-1', title: 'Test Task 1', description: 'Description 1', completed: false},
                    {id: 'compat-test-2', title: 'Test Task 2', description: 'Description 2', completed: true}
                ];
                
                // Test setTasks
                const setResult = storageManager.setTasks(testTasks);
                log('setTasks result:', setResult, setResult ? 'success' : 'error');
                
                // Test saveTasks
                const saveResult = storageManager.saveTasks(testTasks);
                log('saveTasks result:', saveResult, saveResult ? 'success' : 'error');
                
                // Compare results
                if (setResult === saveResult) {
                    log('Both methods return same result:', setResult, 'success');
                    return true;
                } else {
                    log('Methods return different results!', 'error');
                    return false;
                }
                
            } catch (error) {
                log('Error testing method compatibility: ' + error.message, 'error');
                return false;
            }
        }
        
        function testTaskNormalization() {
            clearLog();
            log('=== Testing Task Normalization ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                // Test various task formats
                const testTasks = [
                    // Standard format
                    {id: 'norm-test-1', title: 'Standard Task', description: 'Standard description', completed: false},
                    // Legacy format (text instead of title)
                    {id: 'norm-test-2', text: 'Legacy Task', description: 'Legacy description', completed: true},
                    // Mixed format
                    {id: 'norm-test-3', title: 'Mixed Task', text: 'Also has text', description: 'Mixed description', completed: false},
                    // Invalid data
                    {id: 'norm-test-4', title: 123, description: null, completed: 'yes'},
                    // Missing fields
                    {id: 'norm-test-5', title: 'Minimal Task'}
                ];
                
                log('Testing task normalization with', testTasks.length, 'tasks');
                
                // Test normalization
                const normalized = storageManager.setTasks(testTasks);
                log('Normalization result:', normalized, normalized ? 'success' : 'error');
                
                if (!normalized) {
                    return false;
                }
                
                // Test loading
                const loadedTasks = storageManager.getTasks();
                log('Loaded tasks:', loadedTasks.length, 'success');
                
                // Verify each task
                let allValid = true;
                loadedTasks.forEach((task, index) => {
                    const isValid = task && 
                                   task.id && 
                                   task.title && 
                                   typeof task.title === 'string' &&
                                   task.description && 
                                   typeof task.description === 'string' &&
                                   typeof task.completed === 'boolean';
                    
                    log(`Task ${index + 1} (${task.id}):`, isValid ? 'valid' : 'invalid', isValid ? 'success' : 'error');
                    
                    if (!isValid) {
                        allValid = false;
                        log(`  Invalid task data:`, JSON.stringify(task, null, 2), 'error');
                    }
                });
                
                return allValid;
                
            } catch (error) {
                log('Error testing task normalization: ' + error.message, 'error');
                return false;
            }
        }
        
        function testSaveLoadCycle() {
            clearLog();
            log('=== Testing Save/Load Cycle ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                // Create test tasks
                const originalTasks = [
                    {id: 'cycle-test-1', title: 'Cycle Task 1', description: 'First cycle task', completed: false},
                    {id: 'cycle-test-2', title: 'Cycle Task 2', description: 'Second cycle task', completed: true},
                    {id: 'cycle-test-3', title: 'Cycle Task 3', description: 'Third cycle task', completed: false}
                ];
                
                log('Original tasks:', originalTasks.length);
                
                // Save tasks
                const saveResult = storageManager.setTasks(originalTasks);
                log('Save result:', saveResult, saveResult ? 'success' : 'error');
                
                if (!saveResult) {
                    return false;
                }
                
                // Load tasks
                const loadedTasks = storageManager.getTasks();
                log('Loaded tasks:', loadedTasks.length, 'success');
                
                // Compare
                if (originalTasks.length !== loadedTasks.length) {
                    log('Task count mismatch!', 'error');
                    return false;
                }
                
                // Check each task
                let allMatch = true;
                originalTasks.forEach((original, index) => {
                    const loaded = loadedTasks[index];
                    
                    const matches = original.id === loaded.id &&
                                   original.title === loaded.title &&
                                   original.description === loaded.description &&
                                   original.completed === loaded.completed;
                    
                    log(`Task ${index + 1} match:`, matches, matches ? 'success' : 'error');
                    
                    if (!matches) {
                        allMatch = false;
                        log(`  Original:`, JSON.stringify(original, null, 2), 'info');
                        log(`  Loaded:`, JSON.stringify(loaded, null, 2), 'info');
                    }
                });
                
                return allMatch;
                
            } catch (error) {
                log('Error testing save/load cycle: ' + error.message, 'error');
                return false;
            }
        }
        
        function testMultipleOperations() {
            clearLog();
            log('=== Testing Multiple Operations ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                const testTasks = [
                    {id: 'multi-test-1', title: 'Multi Task 1', description: 'Description 1', completed: false},
                    {id: 'multi-test-2', title: 'Multi Task 2', description: 'Description 2', completed: true}
                ];
                
                let allPassed = true;
                
                // Test 1: Save tasks
                log('Test 1: Save tasks');
                const saveResult = storageManager.setTasks(testTasks);
                log('Save result:', saveResult, saveResult ? 'success' : 'error');
                if (!saveResult) allPassed = false;
                
                // Test 2: Load tasks
                log('Test 2: Load tasks');
                const loadedTasks = storageManager.getTasks();
                log('Loaded tasks:', loadedTasks.length, 'success');
                if (loadedTasks.length !== testTasks.length) allPassed = false;
                
                // Test 3: Update tasks
                log('Test 3: Update tasks');
                const updatedTasks = loadedTasks.map(task => ({
                    ...task,
                    completed: !task.completed,
                    description: task.description + ' (updated)'
                }));
                const updateResult = storageManager.setTasks(updatedTasks);
                log('Update result:', updateResult, updateResult ? 'success' : 'error');
                if (!updateResult) allPassed = false;
                
                // Test 4: Load updated tasks
                log('Test 4: Load updated tasks');
                const finalTasks = storageManager.getTasks();
                log('Final tasks:', finalTasks.length, 'success');
                if (finalTasks.length !== updatedTasks.length) allPassed = false;
                
                // Test 5: Clear tasks
                log('Test 5: Clear tasks');
                const clearResult = storageManager.setTasks([]);
                log('Clear result:', clearResult, clearResult ? 'success' : 'error');
                if (!clearResult) allPassed = false;
                
                // Test 6: Verify cleared
                log('Test 6: Verify cleared');
                const emptyTasks = storageManager.getTasks();
                log('Empty tasks:', emptyTasks.length, 'success');
                if (emptyTasks.length !== 0) allPassed = false;
                
                return allPassed;
                
            } catch (error) {
                log('Error testing multiple operations: ' + error.message, 'error');
                return false;
            }
        }
        
        function testErrorHandling() {
            clearLog();
            log('=== Testing Error Handling ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                let allPassed = true;
                
                // Test 1: Invalid tasks
                log('Test 1: Invalid tasks');
                const invalidTasks = null;
                const invalidResult = storageManager.setTasks(invalidTasks);
                log('Invalid tasks result:', invalidResult, invalidResult ? 'success' : 'error');
                // Should handle gracefully, not crash
                if (invalidResult === false) {
                    log('Correctly handled invalid tasks', 'success');
                } else {
                    log('Unexpected result for invalid tasks', 'warning');
                }
                
                // Test 2: Empty tasks array
                log('Test 2: Empty tasks array');
                const emptyResult = storageManager.setTasks([]);
                log('Empty tasks result:', emptyResult, emptyResult ? 'success' : 'error');
                if (!emptyResult) allPassed = false;
                
                // Test 3: Tasks with invalid data
                log('Test 3: Tasks with invalid data');
                const badTasks = [
                    {id: null, title: 123, description: null, completed: 'yes'},
                    {id: 'bad-test-2', title: '', description: 456, completed: 'no'}
                ];
                const badResult = storageManager.setTasks(badTasks);
                log('Bad tasks result:', badResult, badResult ? 'success' : 'error');
                // Should handle gracefully, not crash
                if (badResult === false || badResult === true) {
                    log('Correctly handled bad tasks', 'success');
                } else {
                    log('Unexpected result for bad tasks', 'warning');
                }
                
                return allPassed;
                
            } catch (error) {
                log('Error testing error handling: ' + error.message, 'error');
                return false;
            }
        }
        
        function testAppIntegration() {
            clearLog();
            log('=== Testing App Integration ===', 'info');
            
            try {
                // Check if TodoApp class exists
                if (typeof TodoApp === 'undefined') {
                    log('TodoApp class not found!', 'error');
                    return false;
                }
                
                log('TodoApp class found:', 'success');
                
                // Check if global instance exists
                if (typeof window.todoApp === 'undefined') {
                    log('Global todoApp instance not found, creating...', 'info');
                    window.todoApp = new TodoApp();
                }
                
                const todoApp = window.todoApp;
                log('TodoApp instance:', todoApp ? 'found' : 'not found', todoApp ? 'success' : 'error');
                
                if (!todoApp) {
                    return false;
                }
                
                // Test app methods
                const methods = ['saveTasks', 'loadTasks', 'addTask', 'deleteTask', 'toggleTask'];
                let allMethodsExist = true;
                
                methods.forEach(method => {
                    const exists = typeof todoApp[method] === 'function';
                    log(`TodoApp has ${method}: ${exists}`, exists ? 'success' : 'error');
                    if (!exists) allMethodsExist = false;
                });
                
                // Test saveTasks method
                if (typeof todoApp.saveTasks === 'function') {
                    log('Testing TodoApp.saveTasks()');
                    const initialCount = todoApp.tasks.length;
                    log('Initial task count:', initialCount);
                    
                    // Add a test task
                    const testTask = {
                        id: 'app-test-' + Date.now(),
                        text: 'App Integration Test',
                        description: 'Testing app integration',
                        completed: false
                    };
                    
                    todoApp.tasks.push(testTask);
                    log('Added test task, new count:', todoApp.tasks.length);
                    
                    // Save tasks
                    todoApp.saveTasks();
                    log('Tasks saved', 'success');
                    
                    // Clear local tasks and reload
                    const savedTasks = [...todoApp.tasks];
                    todoApp.tasks = [];
                    log('Cleared local tasks, count:', todoApp.tasks.length);
                    
                    // Load tasks
                    todoApp.loadTasks();
                    log('Tasks loaded, count:', todoApp.tasks.length);
                    
                    // Verify task was restored
                    const taskFound = todoApp.tasks.some(task => task.id === testTask.id);
                    log('Test task found after load:', taskFound, taskFound ? 'success' : 'error');
                    
                    if (taskFound) {
                        log('App integration test passed!', 'success');
                        return true;
                    } else {
                        log('App integration test failed - task not found', 'error');
                        return false;
                    }
                }
                
                return allMethodsExist;
                
            } catch (error) {
                log('Error testing app integration: ' + error.message, 'error');
                return false;
            }
        }
        
        function testTodoAppInstance() {
            clearLog();
            log('=== Testing TodoApp Instance ===', 'info');
            
            try {
                if (typeof window.todoApp === 'undefined') {
                    log('Global todoApp instance not found!', 'error');
                    return false;
                }
                
                const todoApp = window.todoApp;
                log('TodoApp instance found:', 'success');
                
                // Test instance properties
                const properties = ['tasks', 'isInitialized', 'currentFilter', 'editingTaskId'];
                let allPropertiesExist = true;
                
                properties.forEach(prop => {
                    const exists = todoApp.hasOwnProperty(prop);
                    log(`Has ${prop}: ${exists}`, exists ? 'success' : 'error');
                    if (!exists) allPropertiesExist = false;
                });
                
                // Test task array
                log('Tasks array:', todoApp.tasks ? 'exists' : 'missing', todoApp.tasks ? 'success' : 'error');
                if (todoApp.tasks) {
                    log('Task count:', todoApp.tasks.length, 'info');
                }
                
                // Test save/load methods
                if (typeof todoApp.saveTasks === 'function' && typeof todoApp.loadTasks === 'function') {
                    log('Save/Load methods available:', 'success');
                    
                    // Test save
                    const saveResult = todoApp.saveTasks();
                    log('Save result:', saveResult, saveResult ? 'success' : 'error');
                    
                    // Test load
                    const initialCount = todoApp.tasks.length;
                    todoApp.loadTasks();
                    log('Load completed, task count:', todoApp.tasks.length, 'info');
                    
                    return allPropertiesExist && saveResult;
                } else {
                    log('Save/Load methods missing!', 'error');
                    return false;
                }
                
            } catch (error) {
                log('Error testing TodoApp instance: ' + error.message, 'error');
                return false;
            }
        }
        
        function testEventSystem() {
            clearLog();
            log('=== Testing Event System ===', 'info');
            
            try {
                if (typeof bus === 'undefined') {
                    log('Event bus not found!', 'error');
                    return false;
                }
                
                log('Event bus found:', 'success');
                
                // Test event dispatching
                let eventReceived = false;
                const eventHandler = (e) => {
                    log('Event received:', e.type, 'success');
                    eventReceived = true;
                };
                
                // Add event listener
                bus.addEventListener('tasksUpdated', eventHandler);
                log('Event listener added', 'success');
                
                // Dispatch event
                const customEvent = new CustomEvent('tasksUpdated', {detail: {test: true}});
                bus.dispatchEvent(customEvent);
                log('Event dispatched', 'success');
                
                // Remove event listener
                bus.removeEventListener('tasksUpdated', eventHandler);
                log('Event listener removed', 'success');
                
                return eventReceived;
                
            } catch (error) {
                log('Error testing event system: ' + error.message, 'error');
                return false;
            }
        }
        
        function clearAllStorage() {
            clearLog();
            log('=== Clearing All Storage ===', 'info');
            
            try {
                if (typeof storageManager === 'undefined') {
                    log('Storage Manager not found!', 'error');
                    return false;
                }
                
                const result = storageManager.clearAll();
                if (result) {
                    log('All storage cleared successfully', 'success');
                    return true;
                } else {
                    log('Failed to clear storage', 'error');
                    return false;
                }
                
            } catch (error) {
                log('Error clearing storage: ' + error.message, 'error');
                return false;
            }
        }
        
        function showLocalStorage() {
            clearLog();
            log('=== localStorage Contents ===', 'info');
            
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    log(`Key: ${key}`);
                    log(`Value: ${value.substring(0, 200)}${value.length > 200 ? '...' : ''}`);
                    log('---');
                }
                
            } catch (error) {
                log('Error reading localStorage: ' + error.message, 'error');
            }
        }
        
        // Initialize
        log('Persistence fixes verification page loaded');
        log('Storage Manager available:', typeof storageManager !== 'undefined', typeof storageManager !== 'undefined' ? 'success' : 'error');
        log('TodoApp class available:', typeof TodoApp !== 'undefined', typeof TodoApp !== 'undefined' ? 'success' : 'error');
        log('Global todoApp instance:', typeof window.todoApp !== 'undefined', typeof window.todoApp !== 'undefined' ? 'success' : 'error');
    </script>
</body>
</html>